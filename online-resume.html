<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>履歴書</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <style>
            body {
                font-family: "MS Gothic", sans-serif;
                margin: 0;
                padding: 20px;
                background: #f5f5f5;
                color: #000;
                font-size: 12px;
            }
            .container {
                max-width: 210mm;
                margin: 0 auto;
                background: #fff;
                padding: 20mm;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                min-height: 297mm;
                box-sizing: border-box;
            }
            .header {
                text-align: center;
                margin-bottom: 20px;
            }
            .header h1 {
                font-size: 20px;
                font-weight: bold;
                margin: 0;
                letter-spacing: 6px;
                border: 2px solid #000;
                padding: 10px 20px;
                display: inline-block;
            }
            .date-line {
                text-align: right;
                margin-bottom: 20px;
                font-size: 12px;
            }
            .main-content {
                display: flex;
                gap: 20px;
                margin-bottom: 30px;
            }
            .left-section {
                flex: 1;
            }
            .photo-section {
                width: 90px;
                height: 120px;
                border: 1px solid #000;
                position: relative;
                background: #fafafa;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                overflow: hidden;
            }
            .photo-section img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .photo-placeholder {
                text-align: center;
                font-size: 10px;
                line-height: 1.2;
                color: #666;
                padding: 5px;
            }
            .photo-section input[type="file"] {
                display: none;
            }
            .name-row {
                display: flex;
                align-items: flex-end;
                margin-bottom: 15px;
                border-bottom: 1px solid #000;
                padding-bottom: 10px;
            }
            .name-left {
                flex: 1;
            }
            .furigana-row {
                font-size: 10px;
                margin-bottom: 5px;
            }
            .furigana-input {
                border: none;
                border-bottom: 1px solid #ccc;
                background: transparent;
                font-size: 10px;
                padding: 2px;
                width: 100%;
            }
            .name-input {
                border: none;
                background: transparent;
                font-size: 16px;
                font-weight: bold;
                padding: 5px 0;
                width: 100%;
            }
            .age-section {
                margin-left: 20px;
                font-size: 12px;
                white-space: nowrap;
            }
            .age-input {
                border: none;
                border-bottom: 1px solid #ccc;
                background: transparent;
                width: 30px;
                text-align: center;
                font-size: 12px;
            }
            .info-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
            }
            .info-table td {
                border: 1px solid #000;
                padding: 8px;
                vertical-align: middle;
            }
            .info-label {
                background: #f8f8f8;
                width: 80px;
                font-weight: bold;
                text-align: center;
                font-size: 11px;
            }
            .info-content {
                background: #fff;
            }
            .info-content input,
            .info-content select {
                border: none;
                background: transparent;
                width: 100%;
                font-size: 11px;
                padding: 2px;
            }
            .birthdate-section {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .gender-section {
                display: flex;
                gap: 20px;
                align-items: center;
            }
            .gender-option {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .section-title {
                background: #fff;
                color: #000;
                text-align: center;
                font-weight: bold;
                padding: 8px;
                margin-bottom: 0;
                font-size: 12px;
            }
            .history-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 30px;
            }
            .history-table td {
                border: 1px solid #000;
                padding: 8px;
                vertical-align: top;
            }
            .date-col {
                width: 80px;
                text-align: center;
            }
            .date-col input {
                border: none;
                background: transparent;
                width: 100%;
                text-align: center;
                font-size: 11px;
            }
            .description-col textarea {
                border: none;
                background: transparent;
                width: 100%;
                height: 40px;
                resize: none;
                font-size: 11px;
                line-height: 1.4;
            }
            .motivation-section {
                margin-bottom: 30px;
            }
            .motivation-box {
                border: 2px solid #000;
                min-height: 150px;
                padding: 15px;
                font-size: 16px;
                line-height: 1.6;
                position: relative; /* for placeholder positioning */
            }
            .motivation-div {
                border: none;
                background: transparent;
                width: 100%;
                height: 120px;
                resize: none;
                font-size: 16px;
                line-height: 1.6;
            }
            /* Placeholder for contenteditable motivation-box */
            .motivation-box[contenteditable].show-ph::before {
                content: attr(data-placeholder);
                color: #999;
                position: absolute;
                left: 15px;
                top: 15px;
                right: 15px;
                pointer-events: none;
                white-space: pre-wrap;
            }
            .btn {
                background: #007bff;
                color: #fff;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 11px;
                margin-right: 10px;
                margin-bottom: 10px;
            }
            .btn:hover {
                background: #0056b3;
            }
            .btn-add {
                background: #28a745;
                font-size: 10px;
                padding: 5px 10px;
            }
            .btn-remove {
                background: #dc3545;
                font-size: 10px;
                padding: 3px 8px;
            }
            .controls {
                text-align: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
            }
            .contact-label {
                font-size: 10px;
                color: #666;
                margin-bottom: 5px;
            }
            .note-text {
                font-size: 9px;
                color: #666;
                margin-top: 5px;
            }
            /* Language toolbar (hidden on print) */
            .toolbar {
                background: transparent;
                color: #000;
                font-size: 12px;
            }
            input:focus,
            textarea:focus,
            select:focus {
                outline: 1px solid #007bff;
            }
            @media print {
                @page {
                    margin: 0;
                    size: A4;
                }
                body {
                    background: #fff;
                    padding: 0;
                    font-size: 11px;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .container {
                    box-shadow: none;
                    padding: 10mm;
                    max-width: none;
                    margin: 0;
                }
                .controls {
                    display: none;
                }
                .toolbar {
                    display: none;
                }
                .btn {
                    display: none;
                }
                .photo-section {
                    cursor: default;
                }
                /* Keep borders visible when an element is split across pages */
                .motivation-box {
                    /* Try not to split across pages if there is room */
                    break-inside: avoid-page;
                    page-break-inside: avoid;
                    /* When a split is unavoidable, clone border/padding on fragments */
                    -webkit-box-decoration-break: clone;
                    box-decoration-break: clone;
                }
                /* Keep section title with its content on the same page */
                .section-title {
                    break-after: avoid-page; /* modern */
                    page-break-after: avoid; /* legacy */
                }
                /* Also ask the UA not to break inside the section wrapper */
                .motivation-section {
                    break-inside: avoid-page;
                    page-break-inside: avoid;
                }
                /* And for the common pattern: title immediately followed by box */
                .section-title + .motivation-box {
                    break-inside: avoid-page;
                    page-break-inside: avoid;
                }
                /* Do not print placeholder hint text */
                .motivation-box.show-ph::before {
                    content: none !important;
                }
            }
            #p::-webkit-file-upload-button {
                display: none;
            }

            /* Firefox */
            #p::file-selector-button {
                display: none;
            }
        </style>
    </head>
    <body>
        <div
            class="toolbar"
            id="lang-toolbar"
            style="margin: 10px 0; text-align: right"
        >
            <label
                for="lang"
                data-i18n="toolbar.language"
                style="margin-right: 6px"
                >言語</label
            >
            <select id="lang">
                <option value="ja">日本語</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="container">
            <div class="header"><h1>履　歴　書</h1></div>
            <div class="date-line">
                <input
                    type="date"
                    id="d"
                    style="
                        border: none;
                        border-bottom: 1px solid #000;
                        background: transparent;
                        font-size: 12px;
                    "
                /><span class="now-label" data-i18n="label.now">現在</span>
            </div>
            <div class="main-content">
                <div class="left-section">
                    <div class="name-row">
                        <div class="name-left">
                            <div class="furigana-row">
                                <span data-i18n="label.furigana">ふりがな</span>　<input
                                    type="text"
                                    id="f"
                                    class="furigana-input"
                                />
                            </div>
                            <div>
                                <span data-i18n="label.name">氏　名</span>　<input
                                    type="text"
                                    id="n"
                                    class="name-input"
                                />
                            </div>
                        </div>
                        <div class="age-section">
                            <span data-i18n="label.agePrefix">満</span>
                            <input type="number" id="a" class="age-input" /> 歳
                        </div>
                    </div>
                </div>
                <div class="photo-section" onclick="$('#p').click()">
                    <div class="photo-placeholder" data-i18n-html="placeholder.photoInstructions">
                        写真をはる位置<br />写真をはる必要が<br />ある場合<br /><br />1.縦
                        36～40mm<br />　横 24～30mm<br />2.本人単身胸から上<br />3.裏面のりづけ
                    </div>
                </div>
                <input hidden type="file" id="p" accept="image/*" />
            </div>
            <table class="info-table">
                <tr>
                    <td class="info-label" data-i18n="label.birthdate">生年月日</td>
                    <td class="info-content">
                        <div class="birthdate-section">
                            <input
                                type="date"
                                id="b"
                                style="width: 150px"
                            /><span style="margin-left: 20px">※<span data-i18n="label.gender">性別</span></span>
                            <div
                                class="gender-section"
                                style="margin-left: 20px"
                            >
                                <div class="gender-option">
                                    <input
                                        type="radio"
                                        id="m"
                                        name="g"
                                        value="男"
                                    /><label for="m">男</label>
                                </div>
                                <div class="gender-option">
                                    <input
                                        type="radio"
                                        id="w"
                                        name="g"
                                        value="女"
                                    /><label for="w">女</label>
                                </div>
                            </div>
                        </div>
                        <div class="note-text">
                            ※「性別」欄：記載は任意です。未記載とすることも可能です。
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="info-label">現住所</td>
                    <td class="info-content">
                        <input
                            type="text"
                            id="ad"
                            placeholder="〒　　　　　　　　　　　　都道府県"
                        />
                    </td>
                </tr>
                <tr>
                    <td class="info-label">電話</td>
                    <td class="info-content">
                        <input
                            type="tel"
                            id="ph"
                            placeholder="　　　　　　　　　　　　　　電話"
                            style="width: 200px"
                        />
                    </td>
                </tr>
                <tr>
                    <td class="info-label">連絡先</td>
                    <td class="info-content">
                        <input
                            type="text"
                            id="ca"
                            placeholder="〒"
                            style="margin-bottom: 8px"
                        />
                        <div class="contact-label">
                            (現住所以外に連絡を希望する場合のみ記入)
                        </div>
                        <input
                            type="tel"
                            id="cp"
                            placeholder="電話"
                            style="margin-top: 8px"
                        /><input
                            type="email"
                            id="ce"
                            placeholder="E-mail"
                            style="margin-top: 8px"
                        />
                    </td>
                </tr>
            </table>
            <div class="section-title">
                学 歴 ・ 職 歴 （各別にまとめて書く）
            </div>
            <table class="history-table">
                <tbody id="h">
                    <tr>
                        <td class="date-col">
                            <input
                                type="text"
                                class="date-input"
                                placeholder="年　月"
                            />
                        </td>
                        <td class="description-col">
                            <textarea
                                class="description-input"
                                placeholder="学歴・職歴を入力してください"
                            ></textarea>
                        </td>
                        <td style="width: 60px; text-align: center">
                            <button class="btn btn-remove" onclick="rh(this)">
                                削除
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-add" onclick="ah()">+ 学歴・職歴追加</button>
            <div class="section-title" style="margin-top: 30px">
                資 格 ・ 免 許
            </div>
            <table class="history-table">
                <tbody id="l">
                    <tr>
                        <td class="date-col">
                            <input
                                type="text"
                                class="date-input"
                                placeholder="年　月"
                            />
                        </td>
                        <td class="description-col">
                            <textarea
                                class="description-input"
                                placeholder="取得した資格・免許を入力してください"
                            ></textarea>
                        </td>
                        <td style="width: 60px; text-align: center">
                            <button class="btn btn-remove" onclick="rl(this)">
                                削除
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button class="btn btn-add" onclick="al()">+ 資格・免許追加</button>
            <div class="motivation-section" style="margin-top: 30px">
                <div class="section-title">
                    志望の動機、特技、好きな学科、アピールポイントなど
                </div>
                <div
                    class="motivation-box"
                    contenteditable="true"
                    data-placeholder="志望動機、特技、アピールポイントなどを記入してください"
                ></div>
            </div>
            <div class="motivation-section">
                <div class="section-title">
                    本人希望記入欄（特に給料・職種・勤務時間・勤務地・その他についての希望などがあれば記入）
                </div>
                <div
                    class="motivation-box"
                    contenteditable="true"
                    data-placeholder="給料・職種・勤務時間・勤務地・その他についての希望を記入してください。"
                ></div>
            </div>
            <div class="controls">
                <button class="btn" onclick="save()">データ保存</button>
                <button class="btn" onclick="load()">データ読込</button>
                <button class="btn" onclick="clear()">全て削除</button>
                <button class="btn" onclick="printDoc()">印刷</button>
                <button class="btn" onclick="exportPdf()">PDF出力</button>
            </div>
        </div>
        <input type="file" id="fi" accept=".json" style="display: none" />
        <script src="./i18n/i18n.js"></script>
        <script>
            // Extend i18n dictionary with additional labels/placeholders
            (function () {
                function deepMerge(target, src) {
                    for (const k in src) {
                        if (
                            src[k] &&
                            typeof src[k] === "object" &&
                            !Array.isArray(src[k])
                        ) {
                            if (!target[k] || typeof target[k] !== "object")
                                target[k] = {};
                            deepMerge(target[k], src[k]);
                        } else {
                            target[k] = src[k];
                        }
                    }
                    return target;
                }
                window.I18N_DICT = window.I18N_DICT || {};
                deepMerge(window.I18N_DICT, {
                    ja: {
                        label: {
                            furigana: "ふりがな",
                            name: "氏　名",
                            agePrefix: "満",
                            ageSuffix: "歳",
                            birthdate: "生年月日",
                            gender: "性別",
                            address: "現住所",
                            phone: "電話",
                            contact: "連絡先",
                            male: "男",
                            female: "女",
                            genderOptionalNote:
                                "※『性別』欄：記載は任意です。未記載とすることも可能です。",
                            contactNote:
                                "（現住所以外に連絡を希望する場合のみ記入）",
                        },
                        placeholder: {
                            address: "〒　　　　　　　　　　　　都道府県",
                            phone: "　　　　　　　　　　　　　　電話",
                            contactAddress: "連絡先住所（現住所以外）",
                            email: "E-mail",
                            photoInstructions:
                                "写真をはる位置<br>写真をはる必要がある場合<br><br>1. 縦36〜40mm<br>　 横24〜30mm<br>2. 本人単身胸から上<br>3. 裏面のりづけ",
                        },
                    },
                    en: {
                        label: {
                            furigana: "Furigana",
                            name: "Name",
                            agePrefix: "Age",
                            ageSuffix: "",
                            birthdate: "Birthdate",
                            gender: "Gender",
                            address: "Address",
                            phone: "Phone",
                            contact: "Contact",
                            male: "Male",
                            female: "Female",
                            genderOptionalNote:
                                "Gender field: filling it is optional. You may leave it blank.",
                            contactNote:
                                "(Only fill in if you prefer to be contacted at a different address)",
                        },
                        placeholder: {
                            address: "Postal code, Prefecture / State",
                            phone: "Phone",
                            contactAddress: "Alternate contact address",
                            email: "E-mail",
                            photoInstructions:
                                "Photo area<br>If a photo is required:<br><br>1. 36–40mm tall<br>   24–30mm wide<br>2. Upper body, single person<br>3. Glue on the back",
                        },
                    },
                });
            })();
        </script>
        <script>
            function getLang() {
                return localStorage.getItem("lang") || "ja";
            }
            function setLang(l) {
                localStorage.setItem("lang", l);
            }
            function t(key) {
                const l = getLang();
                const dict = (window.I18N_DICT && window.I18N_DICT[l]) || {};
                return (
                    key
                        .split(".")
                        .reduce(
                            (o, k) => (o && o[k] != null ? o[k] : null),
                            dict
                        ) || key
                );
            }
            function applyTranslations() {
                // generic [data-i18n]
                document.querySelectorAll("[data-i18n]").forEach((el) => {
                    const key = el.getAttribute("data-i18n");
                    el.textContent = t(key);
                });
                // html content
                document.querySelectorAll("[data-i18n-html]").forEach((el) => {
                    const key = el.getAttribute("data-i18n-html");
                    el.innerHTML = t(key);
                });
                // placeholders
                document
                    .querySelectorAll("[data-i18n-placeholder]")
                    .forEach((el) => {
                        const key = el.getAttribute("data-i18n-placeholder");
                        el.setAttribute("placeholder", t(key));
                    });
                // contenteditable placeholder
                const mb = document.querySelector(
                    ".motivation-box[contenteditable]"
                );
                if (mb)
                    mb.setAttribute(
                        "data-placeholder",
                        t("placeholder.motivation")
                    );
                // header fallback (no data-i18n due to encoding issues)
                const h1 = document.querySelector(".header h1");
                if (h1) h1.textContent = t("title.resume");
                // date-line trailing label
                const nowSpan = document.querySelector(
                    ".date-line span.now-label"
                );
                if (nowSpan) nowSpan.textContent = t("label.now");
                // update add buttons if present
                const ahBtn = document.querySelector('button[onclick="ah()"]');
                if (ahBtn) ahBtn.textContent = t("btn.addHistory");
                const alBtn = document.querySelector('button[onclick="al()"]');
                if (alBtn) alBtn.textContent = t("btn.addLicense");
                // update control buttons
                const map = {
                    "save()": "btn.save",
                    "load()": "btn.load",
                    "clear()": "btn.clear",
                    "printDoc()": "btn.print",
                    "exportPdf()": "btn.exportPdf",
                };
                document.querySelectorAll(".controls button").forEach((btn) => {
                    const oc = btn.getAttribute("onclick");
                    if (map[oc]) btn.textContent = t(map[oc]);
                });
                // update initial history/license row placeholders and delete buttons
                document
                    .querySelectorAll("#h .date-input, #l .date-input")
                    .forEach((inp) => {
                        inp.setAttribute(
                            "placeholder",
                            t("placeholder.historyDate")
                        );
                    });
                const hDescs = document.querySelectorAll(
                    "#h .description-input"
                );
                if (hDescs.length)
                    hDescs[0].setAttribute(
                        "placeholder",
                        t("placeholder.historyDesc")
                    );
                const lDescs = document.querySelectorAll(
                    "#l .description-input"
                );
                if (lDescs.length)
                    lDescs[0].setAttribute(
                        "placeholder",
                        t("placeholder.licenseDesc")
                    );
                document
                    .querySelectorAll("#h .btn-remove, #l .btn-remove")
                    .forEach((b) => {
                        b.textContent = t("btn.delete");
                    });
                // section titles
                const st1 = document.querySelectorAll(".section-title");
                if (st1 && st1.length >= 1)
                    st1[0].textContent = t("section.educationWorkTitle");
                if (st1 && st1.length >= 2)
                    st1[1].textContent = t("section.licensesTitle");
                if (st1 && st1.length >= 3)
                    st1[2].textContent = t("section.motivationTitle");
                if (st1 && st1.length >= 4)
                    st1[3].textContent = t("section.personalRequestTitle");
                // fallback updates for labels/placeholders without data-i18n attributes
                const male = document.querySelector('label[for="m"]');
                if (male) male.textContent = t('label.male');
                const female = document.querySelector('label[for="w"]');
                if (female) female.textContent = t('label.female');
                // info-label cells by input IDs adjacency
                const ad = document.getElementById('ad');
                if (ad) {
                    const labelCell = ad.closest('td').previousElementSibling;
                    if (labelCell) labelCell.textContent = t('label.address');
                    ad.setAttribute('placeholder', t('placeholder.address'));
                }
                const ph = document.getElementById('ph');
                if (ph) {
                    const labelCell = ph.closest('td').previousElementSibling;
                    if (labelCell) labelCell.textContent = t('label.phone');
                    ph.setAttribute('placeholder', t('placeholder.phone'));
                }
                const ca = document.getElementById('ca');
                if (ca) {
                    const labelCell = ca.closest('td').previousElementSibling;
                    if (labelCell) labelCell.textContent = t('label.contact');
                    ca.setAttribute('placeholder', t('placeholder.contactAddress'));
                    const note = ca.parentElement.querySelector('.contact-label');
                    if (note) note.textContent = t('label.contactNote');
                }
                const cp = document.getElementById('cp');
                if (cp) cp.setAttribute('placeholder', t('placeholder.phone'));
                const ce = document.getElementById('ce');
                if (ce) ce.setAttribute('placeholder', t('placeholder.email'));
                // ensure photo placeholder has translated HTML even if attribute missing
                const pph = document.querySelector('.photo-placeholder');
                if (pph && !pph.getAttribute('data-i18n-html')) {
                    pph.innerHTML = t('placeholder.photoInstructions');
                }
            }
            // Toggle placeholder for contenteditable motivation-box
            function uph() {
                $(".motivation-box[contenteditable]").each(function () {
                    const isEmpty = $(this).text().trim() === "";
                    $(this).toggleClass("show-ph", isEmpty);
                });
            }
            let D = window.resumeData || {};
            $(() => {
                let t = new Date().toISOString().split("T")[0];
                $("#d").val(t);
                // initialize language UI and texts
                applyTranslations();
                $("#lang").val(localStorage.getItem("lang") || "ja");
                $("#lang").on("change", function () {
                    setLang(this.value);
                    applyTranslations();
                });
                $("#b").on("change", function () {
                    let bd = new Date($(this).val()),
                        td = new Date();
                    let age = td.getFullYear() - bd.getFullYear();
                    let md = td.getMonth() - bd.getMonth();
                    if (md < 0 || (md === 0 && td.getDate() < bd.getDate()))
                        age--;
                    $("#a").val(age);
                    as();
                });
                $("#p").on("change", function (e) {
                    let f = e.target.files[0];
                    if (f) {
                        let r = new FileReader();
                        r.onload = function (e) {
                            let img = $("<img>").attr("src", e.target.result);
                            let input = $("#p").detach();
                            $(".photo-section").empty().append(img);
                            $(".photo-section").parent().append(input);
                            as();
                        };
                        r.readAsDataURL(f);
                    }
                });
                $(document).on(
                    "input change",
                    "input:not(#p),textarea,select",
                    as
                );
                $(document).on(
                    "input blur paste",
                    ".motivation-box[contenteditable]",
                    uph
                );
                ld();
                uph();
            });
            function ah() {
                $("#h").append(
                    `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月"></td><td class="description-col"><textarea class="description-input" placeholder="学歴・職歴を入力してください"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">削除</button></td></tr>`
                );
                as();
            }
            function rh(b) {
                if ($("#h tr").length > 1) $(b).closest("tr").remove();
                else alert("最低1つの項目は必要です。");
                as();
            }
            function al() {
                $("#l").append(
                    `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月"></td><td class="description-col"><textarea class="description-input" placeholder="取得した資格・免許を入力してください"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">削除</button></td></tr>`
                );
                as();
            }
            function rl(b) {
                if ($("#l tr").length > 1) $(b).closest("tr").remove();
                else alert("最低1つの項目は必要です。");
                as();
            }
            function save() {
                let d = gd();
                let s = JSON.stringify(d, null, 2);
                let blob = new Blob([s], { type: "application/json" });
                let url = URL.createObjectURL(blob);
                let link = document.createElement("a");
                link.href = url;
                link.download =
                    "履歴書_" +
                    new Date().toISOString().split("T")[0] +
                    ".json";
                link.click();
                URL.revokeObjectURL(url);
                alert("履歴書データが保存されました！");
            }
            function ld() {
                if (D) rd(D);
            }
            function load() {
                $("#fi").click();
            }
            $("#fi").on("change", function (e) {
                let f = e.target.files[0];
                if (f && f.type === "application/json") {
                    let r = new FileReader();
                    r.onload = function (e) {
                        try {
                            let d = JSON.parse(e.target.result);
                            rd(d);
                            alert("データが正常に読み込まれました！");
                        } catch (error) {
                            alert(
                                "ファイルの読み込みに失敗しました。正しいJSONファイルを選択してください。"
                            );
                        }
                    };
                    r.readAsText(f);
                } else {
                    alert("JSON形式のファイルを選択してください。");
                }
            });
            function rd(d) {
                $("#d").val(d.submitDate || "");
                $("#f").val(d.furigana || "");
                $("#n").val(d.name || "");
                $("#a").val(d.age || "");
                $("#b").val(d.birthdate || "");
                if (d.gender)
                    $(`input[name="g"][value="${d.gender}"]`).prop(
                        "checked",
                        true
                    );
                $("#ad").val(d.address || "");
                $("#ph").val(d.phone || "");
                $("#ca").val(d.contactAddress || "");
                $("#cp").val(d.contactPhone || "");
                $("#ce").val(d.contactEmail || "");
                $("#mo").val(d.motivation || "");
                $("#pn").val(d.personalNotes || "");
                if (d.photo) {
                    let img = $("<img>").attr("src", d.photo);
                    $(".photo-section").empty().append(img);
                }
                if (d.history && d.history.length > 0) {
                    $("#h").empty();
                    d.history.forEach((i) => {
                        $("#h").append(
                            `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月" value="${
                                i.date || ""
                            }"></td><td class="description-col"><textarea class="description-input" placeholder="学歴・職歴を入力してください">${
                                i.description || ""
                            }</textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">削除</button></td></tr>`
                        );
                    });
                }
                if (d.licenses && d.licenses.length > 0) {
                    $("#l").empty();
                    d.licenses.forEach((i) => {
                        $("#l").append(
                            `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月" value="${
                                i.date || ""
                            }"></td><td class="description-col"><textarea class="description-input" placeholder="取得した資格・免許を入力してください">${
                                i.description || ""
                            }</textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">削除</button></td></tr>`
                        );
                    });
                }
            }
            function gd() {
                let d = {
                    submitDate: $("#d").val(),
                    furigana: $("#f").val(),
                    name: $("#n").val(),
                    age: $("#a").val(),
                    birthdate: $("#b").val(),
                    gender: $('input[name="g"]:checked').val(),
                    address: $("#ad").val(),
                    phone: $("#ph").val(),
                    contactAddress: $("#ca").val(),
                    contactPhone: $("#cp").val(),
                    contactEmail: $("#ce").val(),
                    motivation: $("#mo").val(),
                    personalNotes: $("#pn").val(),
                    photo: $(".photo-section img").attr("src") || null,
                    history: [],
                    licenses: [],
                };
                $("#h tr").each(function () {
                    let date = $(this).find(".date-input").val();
                    let desc = $(this).find(".description-input").val();
                    d.history.push({ date, description: desc });
                });
                $("#l tr").each(function () {
                    let date = $(this).find(".date-input").val();
                    let desc = $(this).find(".description-input").val();
                    d.licenses.push({ date, description: desc });
                });
                return d;
            }
            function as() {
                D = gd();
                window.resumeData = D;
            }
            function clear() {
                if (
                    confirm(
                        "全てのデータを削除しますか？この操作は取り消せません。"
                    )
                ) {
                    $(
                        'input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="date"],textarea'
                    ).val("");
                    $('input[type="radio"]').prop("checked", false);
                    $(".photo-section").html(
                        `<input type="file" id="p" accept="image/*"><div class="photo-placeholder">写真をはる位置<br>写真をはる必要が<br>ある場合<br><br>1.縦 36～40mm<br>　横 24～30mm<br>2.本人単身胸から上<br>3.裏面のりづけ</div>`
                    );
                    $(".photo-section")
                        .off("click")
                        .on("click", function () {
                            $("#p").click();
                        });
                    $("#p")
                        .off("change")
                        .on("change", function (e) {
                            let f = e.target.files[0];
                            if (f) {
                                let r = new FileReader();
                                r.onload = function (e) {
                                    let img = $("<img>").attr(
                                        "src",
                                        e.target.result
                                    );
                                    $(".photo-section").empty().append(img);
                                    as();
                                };
                                r.readAsDataURL(f);
                            }
                        });
                    $("#h").html(
                        `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月"></td><td class="description-col"><textarea class="description-input" placeholder="学歴・職歴を入力してください"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">削除</button></td></tr>`
                    );
                    $("#l").html(
                        `<tr><td class="date-col"><input type="text" class="date-input" placeholder="年　月"></td><td class="description-col"><textarea class="description-input" placeholder="取得した資格・免許を入力してください"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">削除</button></td></tr>`
                    );
                    let t = new Date().toISOString().split("T")[0];
                    $("#d").val(t);
                    D = null;
                    window.resumeData = null;
                    alert("全てのデータが削除されました。");
                }
            }
            function printDoc() {
                window.print();
            }
            function exportPdf() {
                alert(
                    "PDF出力機能：\n\n1. ブラウザの印刷機能を使用\n2. 「送信先」で「PDFに保存」を選択\n3. 「詳細設定」で「ヘッダーとフッター」のチェックを外す\n4. 「印刷」ボタンをクリック\n\nまたは、Ctrl+P（Windows）/ Cmd+P（Mac）で印刷画面を開いてください。"
                );
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        </script>
        <script>
            // i18n-aware overrides to unify UI texts and data handling
            $(function () {
                // override add row (history)
                window.ah = function () {
                    const row = `<tr>
                        <td class="date-col"><input type="text" class="date-input" placeholder="${t(
                            "placeholder.historyDate"
                        )}"></td>
                        <td class="description-col"><textarea class="description-input" placeholder="${t(
                            "placeholder.historyDesc"
                        )}"></textarea></td>
                        <td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">${t(
                            "btn.delete"
                        )}</button></td>
                    </tr>`;
                    $("#h").append(row);
                    as();
                };
                // override add row (licenses)
                window.al = function () {
                    const row = `<tr>
                        <td class="date-col"><input type="text" class="date-input" placeholder="${t(
                            "placeholder.historyDate"
                        )}"></td>
                        <td class="description-col"><textarea class="description-input" placeholder="${t(
                            "placeholder.licenseDesc"
                        )}"></textarea></td>
                        <td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">${t(
                            "btn.delete"
                        )}</button></td>
                    </tr>`;
                    $("#l").append(row);
                    as();
                };
                // override remove row handlers for i18n alert
                window.rh = function (b) {
                    if ($("#h tr").length > 1) $(b).closest("tr").remove();
                    else alert(t("error.atLeastOneRow"));
                    as();
                };
                window.rl = function (b) {
                    if ($("#l tr").length > 1) $(b).closest("tr").remove();
                    else alert(t("error.atLeastOneRow"));
                    as();
                };
                // override data gather to read contenteditable motivation boxes
                window.gd = function () {
                    const mBoxes = $(
                        ".motivation-section .motivation-box[contenteditable]"
                    );
                    const motivation = mBoxes.eq(0).text().trim();
                    const personalNotes = mBoxes.eq(1).text().trim();
                    let d = {
                        submitDate: $("#d").val(),
                        furigana: $("#f").val(),
                        name: $("#n").val(),
                        age: $("#a").val(),
                        birthdate: $("#b").val(),
                        gender: $('input[name="g"]:checked').val(),
                        address: $("#ad").val(),
                        phone: $("#ph").val(),
                        contactAddress: $("#ca").val(),
                        contactPhone: $("#cp").val(),
                        contactEmail: $("#ce").val(),
                        motivation,
                        personalNotes,
                        photo: $(".photo-section img").attr("src") || null,
                        history: [],
                        licenses: [],
                    };
                    $("#h tr").each(function () {
                        let date = $(this).find(".date-input").val();
                        let desc = $(this).find(".description-input").val();
                        d.history.push({ date, description: desc });
                    });
                    $("#l tr").each(function () {
                        let date = $(this).find(".date-input").val();
                        let desc = $(this).find(".description-input").val();
                        d.licenses.push({ date, description: desc });
                    });
                    return d;
                };
                // override read to fill contenteditable boxes and i18n placeholders
                window.rd = function (d) {
                    $("#d").val(d.submitDate || "");
                    $("#f").val(d.furigana || "");
                    $("#n").val(d.name || "");
                    $("#a").val(d.age || "");
                    $("#b").val(d.birthdate || "");
                    if (d.gender)
                        $(`input[name="g"][value="${d.gender}"]`).prop(
                            "checked",
                            true
                        );
                    $("#ad").val(d.address || "");
                    $("#ph").val(d.phone || "");
                    $("#ca").val(d.contactAddress || "");
                    $("#cp").val(d.contactPhone || "");
                    $("#ce").val(d.contactEmail || "");
                    const mBoxes = $(
                        ".motivation-section .motivation-box[contenteditable]"
                    );
                    if (mBoxes.length) mBoxes.eq(0).text(d.motivation || "");
                    if (mBoxes.length > 1)
                        mBoxes.eq(1).text(d.personalNotes || "");
                    uph();
                    if (d.photo) {
                        let img = $("<img>").attr("src", d.photo);
                        $(".photo-section").empty().append(img);
                    }
                    if (d.history && d.history.length > 0) {
                        $("#h").empty();
                        d.history.forEach((i) => {
                            $("#h").append(
                                `<tr><td class="date-col"><input type="text" class="date-input" placeholder="${t(
                                    "placeholder.historyDate"
                                )}" value="${
                                    i.date || ""
                                }"></td><td class="description-col"><textarea class="description-input" placeholder="${t(
                                    "placeholder.historyDesc"
                                )}">${
                                    i.description || ""
                                }</textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">${t(
                                    "btn.delete"
                                )}</button></td></tr>`
                            );
                        });
                    }
                    if (d.licenses && d.licenses.length > 0) {
                        $("#l").empty();
                        d.licenses.forEach((i) => {
                            $("#l").append(
                                `<tr><td class="date-col"><input type="text" class="date-input" placeholder="${t(
                                    "placeholder.historyDate"
                                )}" value="${
                                    i.date || ""
                                }"></td><td class="description-col"><textarea class="description-input" placeholder="${t(
                                    "placeholder.licenseDesc"
                                )}">${
                                    i.description || ""
                                }</textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">${t(
                                    "btn.delete"
                                )}</button></td></tr>`
                            );
                        });
                    }
                };
                // override clear (reset + i18n + placeholders + contenteditable)
                window.clear = function () {
                    if (confirm(t("confirm.clearAll"))) {
                        $(
                            'input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="date"],textarea'
                        ).val("");
                        $('input[type="radio"]').prop("checked", false);
                        $(
                            ".motivation-section .motivation-box[contenteditable]"
                        ).text("");
                        uph();
                        $(".photo-section").html(
                            `<input type="file" id="p" accept="image/*"><div class="photo-placeholder">写真をはる位�?br>写真をはる必要が<br>ある場合<br><br>1.�?36�?0mm<br>　�?24�?0mm<br>2.本人単身胸から上<br>3.裏面のりづけ</div>`
                        );
                        $(".photo-section")
                            .off("click")
                            .on("click", function () {
                                $("#p").click();
                            });
                        $("#p")
                            .off("change")
                            .on("change", function (e) {
                                let f = e.target.files[0];
                                if (f) {
                                    let r = new FileReader();
                                    r.onload = function (e) {
                                        let img = $("<img>").attr(
                                            "src",
                                            e.target.result
                                        );
                                        $(".photo-section").empty().append(img);
                                        as();
                                    };
                                    r.readAsDataURL(f);
                                }
                            });
                        $("#h").html(
                            `<tr><td class="date-col"><input type="text" class="date-input" placeholder="${t(
                                "placeholder.historyDate"
                            )}"></td><td class="description-col"><textarea class="description-input" placeholder="${t(
                                "placeholder.historyDesc"
                            )}"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rh(this)">${t(
                                "btn.delete"
                            )}</button></td></tr>`
                        );
                        $("#l").html(
                            `<tr><td class="date-col"><input type="text" class="date-input" placeholder="${t(
                                "placeholder.historyDate"
                            )}"></td><td class="description-col"><textarea class="description-input" placeholder="${t(
                                "placeholder.licenseDesc"
                            )}"></textarea></td><td style="width:60px;text-align:center;"><button class="btn btn-remove" onclick="rl(this)">${t(
                                "btn.delete"
                            )}</button></td></tr>`
                        );
                        let today = new Date().toISOString().split("T")[0];
                        $("#d").val(today);
                        D = null;
                        window.resumeData = null;
                        alert(t("alert.cleared"));
                        applyTranslations();
                    }
                };
                // override save to localize alert
                window.save = function () {
                    let d = gd();
                    let s = JSON.stringify(d, null, 2);
                    let blob = new Blob([s], { type: "application/json" });
                    let url = URL.createObjectURL(blob);
                    let link = document.createElement("a");
                    link.href = url;
                    link.download =
                        "履歴書_" +
                        new Date().toISOString().split("T")[0] +
                        ".json";
                    link.click();
                    URL.revokeObjectURL(url);
                    alert(t("alert.saved"));
                };
                // override exportPdf alert to localized message
                window.exportPdf = function () {
                    alert(t("help.pdf"));
                    setTimeout(() => {
                        window.print();
                    }, 500);
                };
                // re-bind file input change with i18n alerts
                $("#fi")
                    .off("change")
                    .on("change", function (e) {
                        let f = e.target.files[0];
                        if (f && f.type === "application/json") {
                            let r = new FileReader();
                            r.onload = function (e) {
                                try {
                                    let d = JSON.parse(e.target.result);
                                    rd(d);
                                    alert(t("alert.loaded"));
                                } catch (error) {
                                    alert(t("error.loadFailed"));
                                }
                            };
                            r.readAsText(f);
                        } else {
                            alert(t("error.selectJson"));
                        }
                    });
                // ensure UI texts reflect current language
                applyTranslations();
            });
        </script>
    </body>
</html>
